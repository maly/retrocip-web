<!DOCTYPE html>
<html lang="cs-CZ">
  <!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>Nového psa starým trikům nenaučíš</title>

  

  <meta name="description" content="Ptal se mě tuhle jeden čtenář na to, jestli bych někde nevyštrachal svou knížku o osmibitových tricích, protože by ho to zajímalo. Hlavně jestli se něco z toho dá použít ještě dneska… Tak: nedá! Proč? [Tento článek vyšel před rokem původně na mém zápisníku, ovšem zaměřením patří jednoznačně sem, takže jsem...">

  

  

  <link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

  

  

  


  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  

  
  
  

  

  <meta property="og:title" content="Nového psa starým trikům nenaučíš">
  <meta property="og:description" content="Ptal se mě tuhle jeden čtenář na to, jestli bych někde nevyštrachal svou knížku o osmibitových tricích, protože by ho to zajímalo. Hlavně jestli se něco z toho dá použít ještě dneska… Tak: nedá! Proč? [Tento článek vyšel před rokem původně na mém zápisníku, ovšem zaměřením patří jednoznačně sem, takže jsem...">

  
  <meta property="og:image" content="http://localhost:4000/wp-content/uploads/sites/6/favicon/retrocip.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="">
  <meta property="og:article:published_time" content="2014-12-06T12:16:28+01:00">
  <meta property="og:url" content="http://localhost:4000/noveho-psa-starym-trikum-nenaucis/">
  <link rel="canonical" href="http://localhost:4000/noveho-psa-starym-trikum-nenaucis/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@retrocip">
  <meta name="twitter:creator" content="@retrocip">

  <meta property="twitter:title" content="Nového psa starým trikům nenaučíš">
  <meta property="twitter:description" content="Ptal se mě tuhle jeden čtenář na to, jestli bych někde nevyštrachal svou knížku o osmibitových tricích, protože by ho to zajímalo. Hlavně jestli se něco z toho dá použít ještě dneska… Tak: nedá! Proč? [Tento článek vyšel před rokem původně na mém zápisníku, ovšem zaměřením patří jednoznačně sem, takže jsem...">

  
  <meta name="twitter:image" content="http://localhost:4000/wp-content/uploads/sites/6/favicon/retrocip.png">
  

  


  

  

</head>


  <body>
    
 <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/aboutme">About Me</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Resources</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="https://beautifuljekyll.com">Beautiful Jekyll</a>
                  <a class="dropdown-item" href="https://www.markdowntutorial.com/">Learn markdown</a>
            </div>
          </li>
        
          <li class="nav-item">
            <a class="nav-link" href="https://deanattali.com">Author's home</a>
          </li></ul>
  </div>

  

  
    <div class="avatar-container">
      <div class="avatar-img-border">
        <a href="http://localhost:4000/">
          <img alt="Navigation bar avatar" class="avatar-img" src="/wp-content/uploads/sites/6/favicon/retrocip.png" />
        </a>
      </div>
    </div>
  

</nav>
 <!-- TODO this file has become a mess, refactor it -->
<!-- prettier-ignore -->

  



<header class="header-section ">
  
  <div class="intro-header no-img">
    <div class="container-md">
      <div class="row">
        <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
          <div class="post-heading">
            <h1>
              Nového psa starým trikům nenaučíš
            </h1>
             
            <span class="post-meta"
              >Vydáno 6. 12. 2014</span
            >
              
          </div>
        </div>
      </div>
    </div>
  </div>
</header>




<div
  class=" container-md "
>
  <div class="row">
    <div
      class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 "
    >
       

      <article role="main" class="blog-post"><p>Ptal se mě tuhle jeden čtenář na to, jestli bych někde nevyštrachal svou knížku o osmibitových tricích, protože by ho to zajímalo. Hlavně jestli se něco z toho dá použít ještě dneska… Tak: nedá! Proč?</p>

<!--more-->

<p>[Tento článek vyšel před rokem <a href="http://www.misantrop.info/noveho-psa-starym-trikum-nenaucis/">původně na mém zápisníku</a>, ovšem zaměřením patří jednoznačně sem, takže jsem ho přenesl…]</p>

<p>Doba osmibitová byla plná hrdinských činů, kdy mužové s očima rozedřenýma do krve od mihotavého světla mizerných přesvícených televizí ohýbali křemík až na samé hranice jeho možností. Měl jsem v té době ZX Spectrum a rád jsem se hrabal ve zdrojácích, abych viděl, jak pracují ti lepší a přiučil se od nich. Jo, tehdy optimalizace ještě něco znamenala a ušetřit sto bajtů (zhruba tak prostor, který zabírá text perexu tohoto článku) znamenalo mít možnost do nich naprat novou funkci. Stejně tak ušetřit pár taktů uvnitř cyklu… A tak se používaly nejrůznější triky.</p>

<p>Na Spectru jste mohli napsat v BASICu třeba tohle:</p>

<pre>LET a=31</pre>

<p>a do paměti se uložilo mnoho bajtů. V jednom byl kód tokenu LET, v dalších pak znaky „a“, „=“, „3“, „1“, a za tím speciální šestibajtová sekvence, ve které bylo uloženo to číslo (0x1f). _Teď to píšu z hlavy, jsem líný to dohledávat, tak uvidíme, jak si to po dvaadvaceti letech pamatuju… _Dohromady tedy 11 bajtů. Gut. Šlo by to zkrátit? Šlo!</p>

<pre>LET a=VAL "31"</pre>

<p>První bajt byl token pro LET, další pak „a“, „=“, token pro VAL, uvozovka, „3“, „1“ a uvozovka. Tedy osm bajtů. Tedy tři uspořené. Když jste takhle <em>zváleli</em> všechny proměnné, ušetřili jste fakt slušný kus paměti. A některá čísla (0, 1, 3) šly ještě kratším zápisem: NOT PI, SIGN PI, INT PI – LET a=NOT PI zabralo 5 bajtů, LET a=0 deset. Rychlost? Prosímvás, v BASICu? 🙂</p>

<p>Když chcete rychlost, musíte do strojáku.</p>

<p>Tam jsme všichni uctívali velké T. Totiž takt procesoru. Nejkratší instrukce, třeba NOP, přesuny mezi registry nebo prostá aritmetika, zabraly čtyři T. Když jste potřebovali uložit číslo do paměti, mohli jste si vybrat:</p>

<pre>LD ($4000), A ; 13 T
LD (HL), 123 ; 10T
LD (HL), A ; 7 T</pre>

<p>A to jste si museli předtím připravit buď adresu, nebo obsah, nebo obojí do registrů. Když jste potřebovali smazat obrazovku, museli jste zapsat hodnotu 0 na adresy $4000-$57FF. Jedna možnost byla klasická s blokovou instrukcí LDIR:</p>

<pre>LD HL, $4000
LD DE, $4001
LD BC, $17ff
LD (HL),L
LDIR</pre>

<p>což bylo ukrutně pomalé, protože instrukce LDIR sežere na uložení jedné hodnoty 21T. Celá obrazovka se tak mazala skoro 130.000T, takže jste mohli takhle smazat obrazovku zhruba 27krát za sekundu. Nic moc výkon. Nebylo by něco rychlejšího? Co takhle to rozepsat do cyklu? LD (HL), A zabere přeci jen 7T… ale zase nějaký čas sežere režie smyčky.</p>

<p>Po nějakém čase, stráveném s dokumentací, jste přišli na to, že asi nejrychlejší bude použít instrukci PUSH, která během 11T uloží dva bajty a dekrementuje ukazatel zásobníku, a když trošku rozvinete cyklus, tak se dostanete na zhruba polovinu T proti tomu řešení s LDIR:</p>

<pre>LD DE, 0
      LD B, 192
LOOP: PUSH DE
      PUSH DE
      (... celkem 32x)
      DJNZ LOOP</pre>

<p>… a bylo to! (Uschování původní adresy SP jsem tu zanedbal)</p>

<p>Pokud vám nevadily změny příznakových registrů, tak jste nahradili LD A,0 (2 bajty, 7T) instrukcí XOR A (1 bajt, 4T)… atakdál. Náhodná čísla (spíš pseudonáhodná) jste mohli řešit třeba posloupností rotací a XORů s obsahem ROM (a třeba s registrem R). Algoritmus kreslení kruhu, který byl v BASICu řešen jako vykreslení obloukové úseče s úhlem 2PI, jste nahradili Bresenhamovým algoritmem, stejně tak čáru…</p>

<p>A jestli si pamatujete na Busysoftovo „MDA demo“, ve kterém běžel text v borderu, tak vězte, že byl vytvořený jako posloupnost instrukcí OUT (C),D a OUT (C), E – v jednom byla barva, ve druhém pozadí. Jedna čárka tak zabrala 12T, a aby bylo scrollování jemnější, byly před tím dvě instrukce NOP a podle fáze se skákalo buď na první (8 prázdných cyklů na začátku), druhý (4 prázdné cykly) nebo rovnou na OUT (0 prázdných cyklů). Změna obrazce se pak prováděla tak, že blok OUTů byl přepsán tak, aby se střídaly registry D a E podle znakové sady…</p>

<p>Takovéhle optimalizace byly fajn ještě do doby prvních šestnáctibitových procesorů. Pak přišel pipelining, který spoustu triků se samomodifikujícím se kódem „rozbil“ – a už se to nikdy nespravilo.</p>

<p>Dneska podobné optimalizace umí dělat ti maníci, co píšou překladače. Ti znají procesor „do posledního hradla“ a vědí, jak instrukce přeuspořádat tak, aby fungovaly co nejrychleji a aby pomohli procesoru v jeho spekulativních skocích a podobných skopičinách. Pokud nejste takovíhle master silicon nindžové, tak se rozlučte s myšlenkou, že ručně napíšete pro moderní procesor efektivnější kód, než jaký vytvoří optimalizující překladač.</p>

<p>Stejně tak se nevyplácí investovat moc času do optimalizací běžných aplikací, protože paměť i výkon jsou obrovské.</p>

<p>Jestli chcete ještě dneska někde hrát na bajty a cykly procesoru, musíte buď psát nízkoúrovňové ovladače, časově kritické úlohy, nebo embedded aplikace, tam se s podobnými výzvami ještě dneska setkáte.</p>

<p>Takže co zbylo z osmibitových triků pro dnešní použití? Vlastně nic moc, jen nějaké obecné techniky (double/triple buffering například), které nesouvisí až tak moc s procesorem.</p>

<p>Ale bohužel, pro vývoj webu, běžných aplikací, nedejbože Javovských aplikací, tyhle triky nepoužijete. Zato máte k dispozici jiné… Ale to je už jiná pohádka.</p>
</article>

      
      <div class="blog-tags">
        <span>Tagy:</span>
        
        <a href="/tags#CPU">CPU</a>
        
        <a href="/tags#osmibity">osmibity</a>
        
        <a href="/tags#Sinclair">Sinclair</a>
        
        <a href="/tags#Spectrum">Spectrum</a>
        
        <a href="/tags#Z80">Z80</a>
        
        <a href="/tags#ZX">ZX</a>
        
      </div>
         <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=Nov%C3%A9ho+psa+star%C3%BDm+trik%C5%AFm+nenau%C4%8D%C3%AD%C5%A1&url=http%3A%2F%2Flocalhost%3A4000%2Fnoveho-psa-starym-trikum-nenaucis%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fnoveho-psa-starym-trikum-nenaucis%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Fnoveho-psa-starym-trikum-nenaucis%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

</section>


 

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a
            class="page-link"
            href="/par-poznamek-k-esp8266/"
            data-toggle="tooltip"
            data-placement="top"
            title="Pár poznámek k ESP8266"
            >&larr; Předchozí</a
          >
        </li>
         
        <li class="page-item next">
          <a
            class="page-link"
            href="/smart-card/"
            data-toggle="tooltip"
            data-placement="top"
            title="SMART Card"
            >Následující &rarr;</a
          >
        </li>
        
      </ul>
      
  
  
  

  




    </div>
  </div>
</div>
 <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:retrocip@maly.cz" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://www.facebook.com/martin.maly" title="Facebook">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Facebook</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/maly" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/retrocip" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
      2020

      
        &nbsp;&bull;&nbsp;
        <span class="author-site">
          <a href="http://localhost:4000/">Retročip.cz</a>
        </span>
      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>
 
  
    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  








  </body>
</html>
