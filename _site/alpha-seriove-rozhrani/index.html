<!DOCTYPE html>
<html lang="cs-CZ">
  <!-- Beautiful Jekyll 5.0.0 | Copyright Dean Attali 2020 -->
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  

  

  <title>Alpha: Sériové rozhraní</title>

  

  <meta name="description" content="Obsah 1 ACIA 6850 1.1 Řídicí registr CR 1.2 Stavový registr SR 2 6850 a ALPHA 3 Jak pracovat s 6850? 4 Výpis řetězce 5 Hotový program Gratuluji ke zprovoznění počítače. Jen je trošku hloupé, že počítač vlastně umí dělat jen to, co mu vypálíte do EEPROM, a nemůžete s...">

  

  

  <link rel="alternate" type="application/rss+xml" title="" href="http://localhost:4000/feed.xml">

  

  

  


  
    
      
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


    
      
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic">


    
      
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800">


    
  

  
    
      <link rel="stylesheet" href="/assets/css/bootstrap-social.css">
    
      <link rel="stylesheet" href="/assets/css/beautifuljekyll.css">
    
  

  

  
  
  

  

  <meta property="og:title" content="Alpha: Sériové rozhraní">
  <meta property="og:description" content="Obsah 1 ACIA 6850 1.1 Řídicí registr CR 1.2 Stavový registr SR 2 6850 a ALPHA 3 Jak pracovat s 6850? 4 Výpis řetězce 5 Hotový program Gratuluji ke zprovoznění počítače. Jen je trošku hloupé, že počítač vlastně umí dělat jen to, co mu vypálíte do EEPROM, a nemůžete s...">

  
  <meta property="og:image" content="http://localhost:4000/wp-content/uploads/sites/6/favicon/retrocip.png">
  

  
  <meta property="og:type" content="article">
  <meta property="og:article:author" content="">
  <meta property="og:article:published_time" content="2018-05-11T09:38:22+02:00">
  <meta property="og:url" content="http://localhost:4000/alpha-seriove-rozhrani/">
  <link rel="canonical" href="http://localhost:4000/alpha-seriove-rozhrani/">
  

  
  <meta name="twitter:card" content="summary">
  
  <meta name="twitter:site" content="@retrocip">
  <meta name="twitter:creator" content="@retrocip">

  <meta property="twitter:title" content="Alpha: Sériové rozhraní">
  <meta property="twitter:description" content="Obsah 1 ACIA 6850 1.1 Řídicí registr CR 1.2 Stavový registr SR 2 6850 a ALPHA 3 Jak pracovat s 6850? 4 Výpis řetězce 5 Hotový program Gratuluji ke zprovoznění počítače. Jen je trošku hloupé, že počítač vlastně umí dělat jen to, co mu vypálíte do EEPROM, a nemůžete s...">

  
  <meta name="twitter:image" content="http://localhost:4000/wp-content/uploads/sites/6/favicon/retrocip.png">
  

  


  

  

</head>


  <body>
    
 <nav class="navbar navbar-expand-xl navbar-light fixed-top navbar-custom top-nav-regular"><button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="main-navbar">
    <ul class="navbar-nav ml-auto">
          <li class="nav-item">
            <a class="nav-link" href="/aboutme">About Me</a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Resources</a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
                  <a class="dropdown-item" href="https://beautifuljekyll.com">Beautiful Jekyll</a>
                  <a class="dropdown-item" href="https://www.markdowntutorial.com/">Learn markdown</a>
            </div>
          </li>
        
          <li class="nav-item">
            <a class="nav-link" href="https://deanattali.com">Author's home</a>
          </li></ul>
  </div>

  

  
    <div class="avatar-container">
      <div class="avatar-img-border">
        <a href="http://localhost:4000/">
          <img alt="Navigation bar avatar" class="avatar-img" src="/wp-content/uploads/sites/6/favicon/retrocip.png" />
        </a>
      </div>
    </div>
  

</nav>
 <!-- TODO this file has become a mess, refactor it -->
<!-- prettier-ignore -->

  



<header class="header-section ">
  
  <div class="intro-header no-img">
    <div class="container-md">
      <div class="row">
        <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
          <div class="post-heading">
            <h1>
              Alpha: Sériové rozhraní
            </h1>
             
            <span class="post-meta"
              >Vydáno 11. 5. 2018</span
            >
              
          </div>
        </div>
      </div>
    </div>
  </div>
</header>




<div
  class=" container-md "
>
  <div class="row">
    <div
      class=" col-xl-8 offset-xl-2 col-lg-10 offset-lg-1 "
    >
       

      <article role="main" class="blog-post"><div id="toc_container" class="toc_wrap_right no_bullets">
  <p class="toc_title">
    Obsah
  </p>
  
  <ul class="toc_list">
    <li>
      <a href="#ACIA_6850"><span class="toc_number toc_depth_1">1</span> ACIA 6850</a><ul>
        <li>
          <a href="#Ridici_registr_CR"><span class="toc_number toc_depth_2">1.1</span> Řídicí registr CR</a>
        </li>
        <li>
          <a href="#Stavovy_registr_SR"><span class="toc_number toc_depth_2">1.2</span> Stavový registr SR</a>
        </li>
      </ul>
    </li>
    
    <li>
      <a href="#6850_a_ALPHA"><span class="toc_number toc_depth_1">2</span> 6850 a ALPHA</a>
    </li>
    <li>
      <a href="#Jak_pracovat_s_6850"><span class="toc_number toc_depth_1">3</span> Jak pracovat s 6850?</a>
    </li>
    <li>
      <a href="#Vypis_retezce"><span class="toc_number toc_depth_1">4</span> Výpis řetězce</a>
    </li>
    <li>
      <a href="#Hotovy_program"><span class="toc_number toc_depth_1">5</span> Hotový program</a>
    </li>
  </ul>
</div>

<p>Gratuluji ke zprovoznění počítače. Jen je trošku hloupé, že počítač vlastně umí dělat jen to, co mu vypálíte do EEPROM, a nemůžete s ním nijak komunikovat. To teď napravíme. Přidáme první vstupně – výstupní obvod, totiž sériové rozhraní.</p>

<p>Použijeme obvod 6850, přesněji verzi 68B50 (verze B umí pracovat i na frekvenci 2 MHz). Jedná se o obvod,označovaný ACIA – Asynchronous Communications Interface Adapter. Pod slovy „asynchronní komunikační rozhraní“je trochu cudně skryto, že jde o standardní sériové rozhraní, jaké známe z „COM portů“ a dalších sériových portů na počítači. My k jeho výstupům připojíme nějaký převodník USB-to-Serial, a tím získáme možnost komunikovat s Alphou přes terminálový program z počítače.</p>

<blockquote>
  <p>Při testech se ukázalo, že i verze MC6850, tedy bez „B“, zvládne provoz touto rychlostí, ale může se to lišit kus odkusu…</p>
</blockquote>

<h2 id="acia-6850"><span id="ACIA_6850">ACIA 6850<a href="http://retrocip.cz/wp-content/uploads/sites/6/2018/05/MC6850-pinout.png" rel="lightbox"><img loading="lazy" class="aligncenter size-medium wp-image-1072" src="http://retrocip.cz/wp-content/uploads/sites/6/2018/05/MC6850-pinout-609x650.png" alt="" width="609" height="650" srcset="https://retrocip.cz/wp-content/uploads/sites/6/2018/05/MC6850-pinout-609x650.png 609w, https://retrocip.cz/wp-content/uploads/sites/6/2018/05/MC6850-pinout-768x819.png 768w, https://retrocip.cz/wp-content/uploads/sites/6/2018/05/MC6850-pinout-960x1024.png 960w" sizes="(max-width: 609px) 100vw, 609px" /></a></span></h2>

<p>Obvod 6850 je sériový komunikační obvod. Jeho hlavním úkolem je převést zaslaný bajt na sériový signál (tj. správně odvysílat start bit, datové bity, případně paritní bit, a nakonec stop bit) a opačně, tj. načíst správně časovaný sériový signál a připravit ho k předání procesoru.</p>

<p>Asynchronní v popisu znamená, že spolu s daty není přenášen hodinový signál ani není činnost přesně časována –když přijde bajt, je vyslán, když přijdou vstupní sériová data, jsou načtena. Synchronizace, tj. to, že bude načteno opravdu to, co načteno být má, zajišťují právě start a stop bity – podle jejich správného průběhu pozná obvod, že jsou data v pořádku.</p>

<p>Vysílání dat po výstupu TXDATA (Tx = transmit) a příjem na vstupu RXDATA (Rx = receive) je časován pomocí systémových hodin. U našeho počítače je systémový kmitočet roven 1,8432 MHz. Tento kmitočet je v ACIA vnitřně dělen (dělitel je programově nastavitelný na hodnoty 1, 16 a 64). Použijeme dělení 16, což znamená, že komunikační rychlost bude 1843200 / 16 = 115200 bitů za sekundu (baud).</p>

<p>Obvod 6850 s procesorem komunikuje pomocí osmibitové datové sběrnice (D0-D7), několika CS vstupů (CS = ChipSelect), které určují, kdy se s obvodem komunikuje (CS0 = 1, CS1 = 1, /CS2 = 0 – ve všech ostatních případech je datová sběrnice odpojena), vstupu E (Enable, obvod komunikuje jen pokud je E=1), vstupu R/W, který udává, zda se z obvodu čte (1) nebo se do něj zapisuje (0) a vstupu RS, který udává, jestli se čtou/zapisují data (1), nebo řídicí hodnoty(0).</p>

<p>Kromě těchto signálů nabízí i signál /IRQ (Interrupt Request – požadavek na přerušení). Pomocí přerušení může ACIA dát vědět procesoru, že například přišla nějaká data po sériovém portu, nebo že data k odeslání byla odeslána apod. My přerušení nepoužijeme.</p>

<p>Z hlediska programátora se tedy obvod 6850 jeví jako dva registry (vybrané pomocí vstupu RS), z nichž jeden je datový, druhý „systémový“. Funkci osvětlí tabulka:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th> </th>
      <th>VSTUPY</th>
      <th>REGISTRY</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>RS</td>
      <td>R/W</td>
      <td>TYP REGISTRU</td>
      <td>FUNKCE</td>
    </tr>
    <tr>
      <td> </td>
      <td> </td>
      <td>Zápis</td>
      <td>Řídicí registr (Control Register, CR)</td>
    </tr>
    <tr>
      <td> </td>
      <td>1</td>
      <td>Čtení</td>
      <td>Stavový registr (Status Register, SR)</td>
    </tr>
    <tr>
      <td>1</td>
      <td> </td>
      <td>Zápis</td>
      <td>Data k vyslání (Transmit Data Register, TDR)</td>
    </tr>
    <tr>
      <td>1</td>
      <td>1</td>
      <td>Čtení</td>
      <td>Přijatá data (Receive Data Register, RDR)</td>
    </tr>
  </tbody>
</table>

<p>Všimněte si, že do řídicího registru je možné pouze zapisovat, nelze z něj číst, naopak stavový registr lze pouze číst,nelze do něj zapisovat. Není to totiž potřeba. Totéž s datovými registry – při čtení se čte to, co obvod přijal (a nezajímá nás to, co jsme odeslali). Při zápisu je jasné, že chceme data vyslat, nedávalo by smysl zapisovat do přijatých dat.</p>

<h3 id="řídicí-registr-cr"><span id="Ridici_registr_CR">Řídicí registr CR</span></h3>

<p>Osmibitový registr CR řídí čtyři funkce obvodu:</p>

<ul>
  <li>
    <p>Bity 0 a 1 nastavují dělicí poměr hodin, viz výše.<br />
| CR1 | CR0 | DĚLITEL |
| — | — | ——- |
|     |     | 1       |
|     | 1   | 16      |
| 1   |     | 64      |
| 1   | 1   | RESET   |</p>

    <p>Poslední kombinace nenastavuje dělitele, ale celý obvod resetuje do výchozího nastavení, tj. vyprázdní registry anuluje příznaky. My použijeme kombinaci 01, tj. dělení 16. Kdyby bylo potřeba rychlost snížit, použijeme kombinaci 10, tj. dělení 64, a obvod bude komunikovat rychlostí 28800 Bd.&lt;/li&gt;</p>

    <ul>
      <li>Bity 2, 3 a 4 nastavují délku vysílaných a přijímaných dat (sedmibitové nebo osmibitové), zda se pracuje s paritou a kolik je stop bitů. Tyto informace najdete např. i v nastavení Hyperterminálu, když půjdete hledat detaily připojení. Pro naše účely použijeme kombinaci 101, tj. osmibitový přenos, bez parity, 1 stop bit.</li>
      <li>Bity 5 a 6 určují, jestli vysílač po odvysílaném bajtu bude žádat o přerušení a v jakém stavu bude výstup RTS</li>
      <li>Bit 7 určuje, jestli přijímač bude vyvolávat přerušení v případě chyby.&lt;/ul&gt;</li>
    </ul>

    <p>Pro bližší popis odkazuju zájemce opět k datasheetu, my použijeme hodnotu 15h (0 00 101 01 binárně), tj. osmibitový přenos, bez parity, přerušení zakázané a přenosová rychlost 115200 Baud (Baud je jednotka „bitů za sekundu“ –včetně start a stop bitů).</p>

    <h3 id="stavový-registr-sr"><span id="Stavovy_registr_SR">Stavový registr SR</span></h3>

    <p>Svět není dokonalý, život není fér a asynchronní sériové přenosy nejsou nijak sladěné s biorytmy našeho procesoru.Pokud pošlu bajt do 6850, začne ho obvod vysílat. Ovšem předtím je dobré podívat se, jestli už dokončil vysílání toho předchozího. Při příjmu je zase dobré se podívat, jestli nějaký bajt už načetl, a pokud ho načetl, tak ho zpracovat, aby se uvolnilo místo pro další bajt. Popřípadě získat informaci o tom, jestli nedošlo k chybě. Tyhle informace jako když najdete ve stavovém registru SR.</p>

    <p>Pokud načtete bajt ze SR, tak vás jednotlivé bity informují o následujícím:</p>

    <ul>
      <li>Bit 0 – Receiver Data Register Full (RDRF). Pokud je nastaven na 1, znamená to, že obvod načetl bajt po sériové lince do přijímače a bylo by záhodno ho zpracovat. Jakmile procesor přečte stav datového registru, je bit RDRF nastaven na 0. Nula znamená, že žádný nový bajt nepřišel.</li>
      <li>Bit 1 – Transmitter Data Register Empty (TDRE). Jakmile zapíšete do datového registru bajt, nastaví se TDRE na 0 a obvod začne bajt vysílat po sériové lince. Jakmile ho vyšle, nastaví tento bit na 1. Programátor by si měl před tím, než nějaký bajt pošle, zkontrolovat, že může – tedy že bit TDRE = 1.</li>
      <li>Bity 2, 3 pracují s řídicími signály CTS, DCD, a já je tady s klidným svědomím opomenu.</li>
      <li>Bit 4 – Framing Error (FE) znamená, že přijatá data byla špatně časována, např. že nepřišel požadovaný STOP bit.</li>
      <li>Bit 5 – Receiver Overrun (OVRN). Overrun, neboli hezky česky <em>přeběh</em>, je stav, kdy přijímač přijal bajt, ale procesor ještě nezpracoval předchozí přijatý. Ten nově přijatý je tedy zahozený (protože jej není kam dát, žádný vnitřní buffer není) a nastaví se OVRN na 1, aby bylo jasné, že došlo k chybě.</li>
      <li>Bit 6 – Parity Error (PE). Pokud využíváme přenos s paritou, zkontroluje 6850 paritní bit. Pokud byl chybný, nastaví příznak PE.</li>
      <li>Bit 7 – Interrupt Request (IRQ) říká, že obvod požádal o přerušení z nějakého závažného důvodu. Buď byl přijat bajt a je povolené přerušení při přijetí dat, nebo byl odeslán bajt a je povoleno přerušení při odeslání, nebo vypadla nosná (DCD).</li>
    </ul>

    <h2 id="6850-a-alpha"><span id="6850_a_ALPHA">6850 a ALPHA</span></h2>

    <p>Jak připojit tento obvod k naší konstrukci? Tak, je jasné, že datová sběrnice přijde na datovou sběrnici procesoru. Co se vstupy CS, R/W a RS?</p>

    <p>Vstup E povoluje obvodu komunikovat s procesorem (v logické 1). My budeme chtít tento obvod připojit jako periferii,tedy vstupně-výstupní obvod. Vývod IO/M shodou okolností říká právě to, jestli procesor chce pracovat s pamětí (0),nebo s periferií (1). Můžeme ho tedy přímo připojit na vstup E, tím se zajistí, že obvod ACIA bude reagovat jen na požadavky pro zápis a čtení do / z periferií a bude ignorovat operace s pamětí.</p>

    <p>R/W určuje, jestli se bude zapisovat (0) nebo číst (1). V našem systému má podobnou funkci signál /WR – je 0, pokud procesor hodlá zapisovat, jinak je 1, takže může sloužit jako signál čtení (i když není /RD aktivní). Je to v pořádku, stačí to?</p>

    <blockquote>
      <p>Podívejme se na to: Pokud bude procesor chtít zapisovat, pošle správný signál, ve všech ostatních případech bude číst. Nevadí to něčemu? Nevadí, protože bude odpojený od sběrnice díky vstupům CS a E.</p>

      <p>Jenže moment: Podívejte se pořádně na průběhy signálů – signál IO/M je nastaven dřív, než proběhne cyklus ALE,a /WR je přitom neaktivní (=1). Takže ACIA začne číst a posílat hodnoty po datové sběrnici, takže by teoreticky mohl ovlivnit latchování adresy. Teď oceníme oddělovač sběrnice ze začátku této kapitoly.</p>

      <p>Odpověď tedy zní: Nestačí to! Měli bychom signál E držet neaktivní, pokud ALE=1, protože obvod nemá oddělené povolovací vstupy pro zápis a čtení (jako mají třeba paměti). Popřípadě použít /CS2 pro ALE. Ale díky oddělovači to není třeba řešit.</p>
    </blockquote>

    <p>Pracovat se s 6850 bude tedy pomocí instrukcí IN a OUT. Ty používají osmibitovou adresu, takže se teď ještě musíme postarat nějak o to, aby obvod správně z adresy poznal, že procesor komunikuje s ním. Navrhuju, pokud proti tomu nic nemáte, použít vstupy CS0, CS1 a /CS2 a připojit je na adresní vodiče A7, A6 a A5 takto:</p>

    <table>
      <thead>
        <tr>
          <th>A7</th>
          <th>A6</th>
          <th>A5</th>
          <th>A4</th>
          <th>A3</th>
          <th>A2</th>
          <th>A1</th>
          <th>A0</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>CS0</td>
          <td>CS1</td>
          <td>/CS2</td>
          <td>–</td>
          <td>–</td>
          <td>–</td>
          <td>–</td>
          <td>RS</td>
        </tr>
      </tbody>
    </table>

    <p>Obvod bude vybraný pouze tehdy, pokud budou nejvyšší tři bity adresy rovny 110. Na stavu ostatních bitů nebude záležet. Jakákoli adresa, která splní masku „110x xxxx“ vyhoví. Vyhovují tedy adresy C0h – DFh.</p>

    <p>Na nejnižší bit A0 jsem připojil vstup RS. Ten vybírá mezi datovým (1) a řídicím / stavovým registrem (0). Adresy, které budou mít v nejnižším bitu 1, budou přistupovat k datovému registru (C1h, C3h, C5h, … DDh, DFh). Ostatní adresy budou přistupovat k řídicímu či stavovému registru (C0h, C2h, C4h, … DCh, DEh). Programátor si může vybrat kteroukoli z nich, jsou ekvivalentní.</p>

    <p>Přesto doporučuju použít ty adresy, které mají v bitech A1-A4 logické 1. Do budoucna to ušetří případné mrzení s připojováním dalších periferií.</p>

    <p>Proto si zapište- <strong>ACIA v počítači Alpha je zapojena takto:</strong></p>

    <table>
      <thead>
        <tr>
          <th>Adresa</th>
          <th>Zápis</th>
          <th>Čtení</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>0DEh</td>
          <td>Řídicí registr</td>
          <td>Stavový registr</td>
        </tr>
        <tr>
          <td>0DFh</td>
          <td>Data k odeslání</td>
          <td>Přijatá data</td>
        </tr>
      </tbody>
    </table>

    <p>Musíme také přivést hodinový signál na vstupy RXCLK a TXCLK. Oba spojíme, protože chceme vysílat stejnou frekvencí jako přijímat. Připojíme je na vývod CLK z procesoru.Signál /RTS budeme ignorovat, vstupy /CTS a /DCD, sloužící k řízení přenosu, připojíme na zem.</p>

    <p>Vývody RXDATA (vstup) a TXDATA (výstup) jsou už to sériové rozhraní… připojte je k převodníku USB-to-UART, samosebou kříženě (TxD na vstup RXDATA, RxD na výstup TXDATA). Počítač je připraven komunikovat, stačí ho jen naprogramovat!</p>

    <p><a href="http://retrocip.cz/wp-content/uploads/sites/6/2018/05/alpha85-acia.png" rel="lightbox"><img loading="lazy" class="aligncenter size-medium wp-image-1073" src="http://retrocip.cz/wp-content/uploads/sites/6/2018/05/alpha85-acia-650x393.png" alt="" width="650" height="393" srcset="https://retrocip.cz/wp-content/uploads/sites/6/2018/05/alpha85-acia-650x393.png 650w, https://retrocip.cz/wp-content/uploads/sites/6/2018/05/alpha85-acia-768x465.png 768w, https://retrocip.cz/wp-content/uploads/sites/6/2018/05/alpha85-acia-1024x619.png 1024w" sizes="(max-width: 650px) 100vw, 650px" /></a></p>

    <h2 id="jak-pracovat-s-6850"><span id="Jak_pracovat_s_6850">Jak pracovat s 6850?</span></h2>

    <p>Na začátku musíme nastavit řídicí registr tak, jak potřebujeme. Už jsme si řekli, že to bude hodnota 15h. Tím je obvod nastaven a připraven k přijímání a vysílání dat. Rozšíříme tedy naší inicializační sekci:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .ORG    0 
    
                    ; inicializace()
    
COLD:       DI      
    
            LXI     SP,0000h 
    
                    ; adresace sériového rozhraní
ACIA        EQU     0DEh 
ACIAC       EQU     ACIA 
ACIAS       EQU     ACIA 
ACIAD       EQU     ACIA+1 
    
                    ;inicializace ACIA
            MVI     A,15h ; 115200 Bd, 8 bit, no parity, 1 stop bit, no IRQ
            OUT     ACIAC
</code></pre></div>    </div>

    <p>Na začátku jsou pojmenované adresy ACIA (bázová adresa obvodu 6850 v našem počítači), ACIAC(ontrol), ACIAS(tatus) a ACIAD(ata). Vyhneme se tak programátorskému moru, „magickým konstantám“.</p>

    <p>Do registru A uložíme požadované řídicí slovo (15h) a instrukcí OUT ho zapíšete na adresu ACIAControl (tj. 0DEh).Vnější logika našeho počítače se postará o to, že data neskončí v paměti, ale tam, kde mají, tj. v obvodu 6850.</p>

    <p>Co dál? Obvod je nastaven, teď je zapotřebí vypsat ono obligátní HELLO WORLD. Někde v paměti tedy bude tenhle řetězec a my ho budeme bajt po bajtu procházet a vysílat na sériový výstup.</p>

    <p>Když se řekne „vysílat“, tak si na to uděláme podprogram. Bude se jmenovat třeba SEROUT (jako že SERial OUTput) ajeho funkce bude, že vyšle hodnotu v registru A. Předtím si ale zkontroluje, jestli je vysílač volný. Musí si tedy načíst hodnotu stavového registru SR a zkontrolovat bit 1 (TDRE). Pokud je nulový, musí počkat, až bude 1.</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ACIA_TDRE   EQU     02h
SEROUT:             
            PUSH    PSW 
SO_WAIT:            
            IN      ACIAS 
            ANI     ACIA_TDRE ;bit TDRE - pokud lze vysílat, je =1
            JZ      SO_WAIT 
            POP     PSW 
            OUT     ACIAD 
            RET
</code></pre></div>    </div>

    <p>Na začátku si uložím obsah registru A. Mám v něm ten bajt, co chci vyslat, ale budu ten registr potřebovat, protože si do něj načtu hodnotu stavového registru. Takže si jeho hodnotu uložím na zásobník.</p>

    <p>Na dalším řádku načtu hodnotu stavového registru do registru A. Pak provedu logický součin (AND) s hodnotou 2.Hodnota 2 totiž binárně vypadá takto: 00000010 – jsou to tedy samé nuly, jen na pozici bitu 1, který potřebuju testovat, je jednička. Výsledkem logického součinu bude buď hodnota 2, pokud je bit 1 nastaven, nebo 0, pokud je nulový.</p>

    <p>Připomeňme si: pokud je bit 1 stavového registru nulový, znamená to, že obvod 6850 ještě vysílá předchozí data a my musíme počkat, dokud to nedokončí. Tedy pokud je (hodnota stavového registru AND 02) rovna nule, čekáme. A přesně to zajišťuje další instrukce JZ. Pokud je příznak Z=1 (tedy předchozí operace skončila s výsledkem 0), tak JZ skáče. Tady se skáče opět na načtení stavového bajtu a vše se opakuje, dokud není výsledek nenulový. V tu chvíli už víme, že má 6850 volno a můžeme vysílat.</p>

    <p>Pokud je tedy volno, přečteme si ze zásobníku zpět hodnotu, co byla původně v registru A a pomocí OUT ji zapíšeme do datového registru 6850 – ACIAData.</p>

    <p>Správná otázka je: Co se stane, když náhodou bude obvod 6850 vadný, nebo nebude zapojený správně a bude vracet pořád hodnotu 0? V takovém případě, ano, tušíte správně, jste právě vygenerovali nekonečnou smyčku, ve které se bude procesor točit do skonání věků – pardon, do vypnutí napájení, do RESETu nebo do přerušení.</p>

    <h2 id="výpis-řetězce"><span id="Vypis_retezce">Výpis řetězce</span></h2>

    <p>Už zbývá jen detail – dát to všechno dohromady. Máme inicializovaný obvod ACIA, máme někde podprogram, který umí poslat znak na sériové rozhraní, teď už jen stačí vytvořit smyčku, která bude posílat jednotlivé znaky nejznámějšího nápisu v historii programování.</p>

    <p>Buď můžeme zvolit postup mechanický, tedy postupně volat SEROUT s hodnotami pro znaky H, E, L, L, O… v registru A, nebo si ty znaky můžeme někam nějak zapsat a ve smyčce je postupně načítat.</p>

    <p>Nejjednodušší způsob je uložit si nápis někam do paměti jako posloupnost znaků. K tomu slouží direktiva DB. Na začátku programu si do registrů HL uložíte adresu prvního znaku nápisu. Pak stačí jen opakovat následující postup:</p>

    <ol>
      <li>Přečíst hodnotu z adresy, na kterou ukazuje HL, do registru A: MOV A, M</li>
      <li>Zavolat SEROUT: CALL SEROUT</li>
      <li>Zvýšit hodnotu HL o 1: INX H</li>
      <li>Opakovat od bodu 1: JMP 1</li>
    </ol>

    <p>Ale pozor – takto zapsáno to je nekonečná smyčka, která bude posílat stále dokola kompletní obsah paměti. Potřebujeme říct, kdy má přestat.</p>

    <p>Používají se v zásadě tři postupy. První je ten, že za poslední znak dáme ještě znak 0. Někdy se tomu říká také ASCIIZ (ASCII s ukončovací nulou – Zero), někdy se tomu říká CSTR (protože takový způsob ukládání řetězců volí jazyk C).Pokud v bodu 1 načteme hodnotu 0, tak je vypsaný celý řetězec a můžeme skončit. Nevýhoda: Součástí řetězce nesmí být samotný kód 0.</p>

    <p>Druhý způsob je ten, že jako první hodnotu řetězce dáme jeden byte, který bude obsahovat délku řetězce v bajtech.Tomuto způsobu se také někdy říká PSTR, protože takto ukládá řetězce Pascal. Algoritmus je o něco složitější:</p>

    <ol>
      <li>Přečíst hodnotu z adresy HL do registru C: MOV C, M</li>
      <li>Zvýšit hodnotu HL o 1: INX H</li>
      <li>Přečíst hodnotu z adresy, na kterou ukazuje HL, do registru A: MOV A, M</li>
      <li>Zavolat SEROUT: CALL SEROUT</li>
      <li>Zvýšit hodnotu HL o 1: INX H</li>
      <li>Snížit hodnotu C (Counter) o 1: DCR C</li>
      <li>Pokud je hodnota nenulová, skočit na bod 3: JNZ 3</li>
    </ol>

    <p>Ve skutečnosti zkušený programátor vynechá bod 5 a v bodě 7 skáče na bod 2 – tím ušetří jeden bajt. Je jedno, jestli se hodnota HL zvýší před skokem, nebo po skoku, efekt je stejný. Nevýhoda: řetězec může mít maximálně 256 znaků.</p>

    <p>Třetí způsob využívá toho, že se většinou u takových počítačů používá jen prostá znaková sada ASCII, která má definované znaky jen v rozsahu 00 – 7Fh. Tedy žádné speciální, semigrafické, přehlásky, … Pokud je tomu tak, tak se použije způsob, podobný tomu prvnímu, ale s tím rozdílem, že místo toho, abychom za poslední znak přidali 0, tak my zapíšeme poslední znak tak, že mu nastavíme nejvyšší bit na 1 (tedy ho posuneme do rozmezí 80h-FFh). Výhoda je, že řetězec nezabírá ani o jediný byte navíc. Nevýhoda je, kromě toho, že nelze použít speciální znaky, třeba i složitější obsluha, ale zas tak hrozné to není. Představme si podprogram STROUT, který tento postup implementuje:</p>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>STROUT:
        MOV A,M
        ANI 7Fh
        CALL SEROUT
        MOV A,M
        ANI 80h
        RNZ
        INX H
        JMP STROUT
</code></pre></div>    </div>

    <p>Načtený bajt nejprve ošetříme a případný nastavený bit 7 znulujeme. Pak výsledek pošleme na výstup.</p>

    <p>Znovu si načteme stejný bajt, a tentokrát se podíváme na nejvyšší bit. Pokud je nenulový, máme vše za sebou a vracíme se pryč (RNZ). Jinak standardní postup: Přejít na další adresu a celé opakovat znovu!</p>

    <p>Všechny tři postupy mají svá pro a proti a své výhody a omezení. Který způsob použijete, to záleží na vás. V dobách osmibitů se hojně používal poslední (s negovaným bitem 7), ale pokud počítáte s tím, že například budete zobrazovat i jiné znaky než standardní sedmibitové ASCII, musíte zvolit jiný postup. Koncová nula je široce používaná dnes, právě díky tomu, že takto implementuje řetězce standardní Céčko. Takový řetězec může mít libovolnou délku, ale nesmí sám obsahovat nulu. Navíc to každý řetězec prodlouží o jeden byte.</p>

    <h2 id="hotový-program"><span id="Hotovy_program">Hotový program</span></h2>

    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>            .ORG    0 
    
                    ; inicializace()
    
COLD:       DI      
    
            LXI     SP,0000h 
    
                    ; adresace sériového rozhraní
ACIA        EQU     0DEh 
ACIAC       EQU     ACIA 
ACIAS       EQU     ACIA 
ACIAD       EQU     ACIA+1 
    
ACIA_TDRE   EQU     02h 
    
                    ;inicializace ACIA
            MVI     A,15h ; 115200 Bd, 8 bit, no parity, 1 stop bit, no IRQ
            OUT     ACIAC 
    
WARM:               
            LXI     H,HELLO 
            CALL    STROUT 
    
            JMP     WARM 
    
SEROUT:             
            PUSH    PSW 
SO_WAIT:            
            IN      ACIAS 
            ANI     ACIA_TDRE ;bit TDRE - pokud lze vysílat, je =1
            JZ      SO_WAIT 
            POP     PSW 
            OUT     ACIAD 
            RET     
    
STROUT:             
            MOV     A,M 
            ANI     7Fh 
            CALL    SEROUT 
            MOV     A,M 
            ANI     80h 
            RNZ     
            INX     H 
            JMP     STROUT 
    
HELLO:              
            DB      "HELLO WORLD",0Dh,0Ah+80h
</code></pre></div>    </div>

    <p>Na začátku proběhne inicializace – studený (cold) start. Nastaví se zásobník (bez něj by nefungovaly podprogramy) a obvod ACIA. Po inicializaci startuje vlastní obslužný program (teplý start). Tedy program: uloží do HL adresu řetězce, zavolá funkci STROUT a jede se znovu.</p>

    <p>Zvolil jsem nakonec ukládání řetězců „tradičně osmibitově“. Na posledním řádku vidíte znaky k výpisu. Znak 0Dh je řídicí znak pro terminál, konkrétně CR – návrat kurzoru na začátek řádku. 0Ah je přechod na nová řádek. A protože znak přechodu na nový řádek je poslední, musí být jeho hodnota zvýšena o 80h (což je ekvivalent nastavení bitu 7)</p>

    <blockquote>
      <p>Assembler ASM80 s těmito triky počítá, tak nabízí pseudoinstrukce .pstr, .cstr a .istr – příklad:</p>

      <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    .PSTR "HELLO WORLD"
    .CSTR "HELLO WORLD"
    .ISTR "HELLO WORLD"
</code></pre></div>      </div>

      <p>Všechny tři uloží do paměti řetězec HELLO WORLD, ale první ho uloží v „Pascal style“, tedy první byte bude délka a za ním znaky. Druhý ho uloží v „C style“ s nulou na konci. Třetí ho uloží v „inverted style“ – tedy poslední znak s nastaveným bitem 7.</p>
    </blockquote>
  </li>
</ul>
</article>

      
      <div class="blog-tags">
        <span>Tagy:</span>
        
        <a href="/tags#6850">6850</a>
        
        <a href="/tags#8085">8085</a>
        
        <a href="/tags#ACIA">ACIA</a>
        
        <a href="/tags#MC6850">MC6850</a>
        
        <a href="/tags#OMEN Alpha">OMEN Alpha</a>
        
      </div>
         <!-- Check if any share-links are active -->




<section id = "social-share-section">
  <span class="sr-only">Share: </span>

  
    <a href="https://twitter.com/intent/tweet?text=Alpha%3A+S%C3%A9riov%C3%A9+rozhran%C3%AD&url=http%3A%2F%2Flocalhost%3A4000%2Falpha-seriove-rozhrani%2F"
      class="btn btn-social-icon btn-twitter" title="Share on Twitter">
      <span class="fab fa-fw fa-twitter" aria-hidden="true"></span>
      <span class="sr-only">Twitter</span>
    </a>
  

  
    <a href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Falpha-seriove-rozhrani%2F"
      class="btn btn-social-icon btn-facebook" title="Share on Facebook">
      <span class="fab fa-fw fa-facebook" aria-hidden="true"></span>
      <span class="sr-only">Facebook</span>
    </a>
  

  
    <a href="https://www.linkedin.com/shareArticle?mini=true&url=http%3A%2F%2Flocalhost%3A4000%2Falpha-seriove-rozhrani%2F"
      class="btn btn-social-icon btn-linkedin" title="Share on LinkedIn">
      <span class="fab fa-fw fa-linkedin" aria-hidden="true"></span>
      <span class="sr-only">LinkedIn</span>
    </a>
  

  

</section>


 

      <ul class="pagination blog-pager">
        
        <li class="page-item previous">
          <a
            class="page-link"
            href="/alpha-prvni-program/"
            data-toggle="tooltip"
            data-placement="top"
            title="Alpha: První program"
            >&larr; Předchozí</a
          >
        </li>
         
        <li class="page-item next">
          <a
            class="page-link"
            href="/dejme-hlavy-dohromady/"
            data-toggle="tooltip"
            data-placement="top"
            title="Dejme hlavy dohromady&#8230;"
            >Následující &rarr;</a
          >
        </li>
        
      </ul>
      
  
  
  

  




    </div>
  </div>
</div>
 <footer>
  <div class="container-md beautiful-jekyll-footer">
    <div class="row">
      <div class="col-xl-8 offset-xl-2 col-lg-10 offset-lg-1">
      <ul class="list-inline text-center footer-links"><li class="list-inline-item">
    <a href="/feed.xml" title="RSS">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">RSS</span>
    </a>
  </li><li class="list-inline-item">
    <a href="mailto:retrocip@maly.cz" title="Email me">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Email me</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://www.facebook.com/martin.maly" title="Facebook">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Facebook</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://github.com/maly" title="GitHub">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">GitHub</span>
   </a>
  </li><li class="list-inline-item">
    <a href="https://twitter.com/retrocip" title="Twitter">
      <span class="fa-stack fa-lg" aria-hidden="true">
        <i class="fas fa-circle fa-stack-2x"></i>
        <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
      </span>
      <span class="sr-only">Twitter</span>
   </a>
  </li></ul>

      
      <p class="copyright text-muted">
      
      2020

      
        &nbsp;&bull;&nbsp;
        <span class="author-site">
          <a href="http://localhost:4000/">Retročip.cz</a>
        </span>
      

      
      </p>
      <p class="theme-by text-muted">
        Powered by
        <a href="https://beautifuljekyll.com">Beautiful Jekyll</a>
      </p>
      </div>
    </div>
  </div>
</footer>
 
  
    
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha256-4+XzXVhsDmqanXGHaHvgh1gMQKX40OUvDEBTu8JcmNs=" crossorigin="anonymous"></script>


  
    
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>


  
    
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>


  



  
    <!-- doing something a bit funky here because I want to be careful not to include JQuery twice! -->
    
      <script src="/assets/js/beautifuljekyll.js"></script>
    
  








  </body>
</html>
